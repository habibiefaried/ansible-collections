---
# inventory.ini
# Save this as inventory.ini in the same directory
#
# [masters]
# master1 ansible_host=192.168.1.10 ansible_user=ubuntu
# master2 ansible_host=192.168.1.11 ansible_user=ubuntu
# master3 ansible_host=192.168.1.12 ansible_user=ubuntu
#
# [workers]
# worker1 ansible_host=192.168.1.20 ansible_user=ubuntu
# worker2 ansible_host=192.168.1.21 ansible_user=ubuntu
# worker3 ansible_host=192.168.1.22 ansible_user=ubuntu
#
# [k8s_cluster:children]
# masters
# workers

- name: Deploy MicroK8s Cluster on Debian
  hosts: k8s_cluster
  become: yes
  gather_facts: no
  
  vars:
    microk8s_channel: "latest/stable"
    microk8s_plugins:
      - dns
      - storage
      - ingress
    primary_master: "{{ groups['masters'][0] }}"
  
  tasks:
    # Phase 0: Bootstrap Python and gather facts
    - name: Install Python3 and dependencies (raw command, no Python required)
      raw: |
        apt-get update
        apt-get install -y python3 python3-apt
      changed_when: false
      tags: bootstrap

    - name: Wait for system to settle
      raw: sleep 2
      changed_when: false
      tags: bootstrap

    - name: Gather facts after Python installation
      setup:
      tags: bootstrap

    # Phase 1: Prepare all nodes
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: prepare

    - name: Install Python3 and dependencies
      apt:
        name:
          - python3
          - python3-pip
          - apt-transport-https
          - ca-certificates
          - curl
          - snapd
        state: present
      tags: prepare

    - name: Ensure snapd service is running
      systemd:
        name: snapd
        state: started
        enabled: yes
      tags: prepare

    - name: Wait for snapd to be ready
      command: snap wait system seed.loaded
      changed_when: false
      tags: prepare

    # Disable firewall for MicroK8s
    - name: Disable UFW firewall
      systemd:
        name: ufw
        state: stopped
        enabled: no
      ignore_errors: yes
      tags: prepare

    - name: Disable firewalld (if present)
      systemd:
        name: firewalld
        state: stopped
        enabled: no
      ignore_errors: yes
      tags: prepare

    - name: Enable IP forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        sysctl_set: yes
        state: present
        reload: yes
      tags: prepare

    - name: Enable bridge netfilter
      modprobe:
        name: br_netfilter
        state: present
      tags: prepare

    - name: Make br_netfilter persistent
      lineinfile:
        path: /etc/modules-load.d/k8s.conf
        line: br_netfilter
        create: yes
      tags: prepare

    - name: Configure bridge networking
      sysctl:
        name: "{{ item }}"
        value: '1'
        sysctl_set: yes
        state: present
        reload: yes
      loop:
        - net.bridge.bridge-nf-call-iptables
        - net.bridge.bridge-nf-call-ip6tables
      tags: prepare

    # Phase 2: Install MicroK8s on all nodes
    - name: Remove existing MicroK8s installation
      command: snap remove microk8s --purge
      register: microk8s_remove
      failed_when: false
      changed_when: microk8s_remove.rc == 0
      tags: install

    - name: Display removal result
      debug:
        var: microk8s_remove
      tags: install

    - name: Wait for snap removal to complete
      pause:
        seconds: 10
      tags: install

    - name: Install MicroK8s using snap command
      command: snap install microk8s --classic --channel={{ microk8s_channel }}
      register: microk8s_install
      retries: 3
      delay: 10
      until: microk8s_install.rc == 0
      tags: install

    - name: Display installation result
      debug:
        var: microk8s_install
      tags: install

    - name: Wait for snap installation to complete
      pause:
        seconds: 10
      tags: install

    - name: Add user to microk8s group
      user:
        name: "{{ ansible_user }}"
        groups: microk8s
        append: yes
      tags: install

    - name: Create .kube directory
      file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'
      tags: install

    - name: Wait for MicroK8s to be ready
      shell: /snap/bin/microk8s status --wait-ready
      changed_when: false
      retries: 10
      delay: 10
      tags: install

    # Phase 3: Configure primary master
    - name: Enable MicroK8s addons on primary master
      shell: "/snap/bin/microk8s enable {{ item }}"
      loop: "{{ microk8s_plugins }}"
      when: inventory_hostname == primary_master
      register: enable_addons
      changed_when: "'Enabling' in enable_addons.stdout"
      tags: configure

    - name: Display addon enablement results
      debug:
        var: enable_addons
      when: inventory_hostname == primary_master
      tags: configure

    - name: Enable HA clustering on primary master
      shell: /snap/bin/microk8s enable ha-cluster
      when: inventory_hostname == primary_master
      register: ha_enable
      changed_when: "'Enabling' in ha_enable.stdout"
      tags: configure

    - name: Display HA cluster enablement result
      debug:
        var: ha_enable
      when: inventory_hostname == primary_master
      tags: configure

    - name: Wait for primary master to be ready
      shell: /snap/bin/microk8s status --wait-ready
      when: inventory_hostname == primary_master
      changed_when: false
      tags: configure

    ###########################################################################
    # PHASE 4 — FIXED: Per-node join tokens
    ###########################################################################

    # Generate one add-node output per master (except primary)
    - name: Generate per-master join tokens (one for each additional master)
      shell: /snap/bin/microk8s add-node --token-ttl -1
      when: inventory_hostname == primary_master
      loop: "{{ groups['masters'] | difference([primary_master]) }}"
      loop_control:
        loop_var: master_node
      register: master_join_outputs
      changed_when: false
      tags: cluster

    - name: Extract join token for each master
      when: inventory_hostname == primary_master
      set_fact:
        master_join_map: >-
          {{
            dict(
              (item.master_node,
               (item.stdout_lines
                 | select('match', '.*microk8s join.*')
                 | reject('match', '.*--worker.*')
                 | first))
              for item in master_join_outputs.results
            )
          }}
      tags: cluster

    - name: Display per-master join token map
      debug:
        var: master_join_map
      when: inventory_hostname == primary_master
      tags: cluster

    # Worker tokens: one per worker
    - name: Generate per-worker join tokens
      shell: /snap/bin/microk8s add-node --token-ttl -1
      when: inventory_hostname == primary_master
      loop: "{{ groups['workers'] }}"
      loop_control:
        loop_var: worker_node
      register: worker_join_outputs
      changed_when: false
      tags: cluster

    - name: Extract worker join tokens with --worker flag
      when: inventory_hostname == primary_master
      set_fact:
        worker_join_map: >-
          {{
            dict(
              (item.worker_node,
               (item.stdout_lines
                 | select('match', '.*microk8s join.*--worker')
                 | first))
              for item in worker_join_outputs.results
            )
          }}
      tags: cluster

    - name: Display per-worker join token map
      debug:
        var: worker_join_map
      when: inventory_hostname == primary_master
      tags: cluster

    ###########################################################################
    # PHASE 5 — Join additional masters (each uses its own token)
    ###########################################################################

    - name: Store master join token (per-node)
      set_fact:
        master_token: "{{ hostvars[primary_master]['master_join_map'][inventory_hostname] }}"
      when:
        - inventory_hostname in groups['masters']
        - inventory_hostname != primary_master
      tags: cluster

    - name: Display master join command that will be executed
      debug:
        msg: "Joining master node {{ inventory_hostname }} to cluster with command:\n{{ master_token | replace('microk8s', '/snap/bin/microk8s') }}"
      when:
        - inventory_hostname in groups['masters']
        - inventory_hostname != primary_master
      tags: cluster

    - name: Join additional master nodes to cluster
      shell: "{{ master_token | replace('microk8s', '/snap/bin/microk8s') }}"
      when:
        - inventory_hostname in groups['masters']
        - inventory_hostname != primary_master
      register: master_join_result
      changed_when: "'Successfully joined' in master_join_result.stdout or master_join_result.rc == 0"
      failed_when: false
      tags: cluster

    - name: Display master join command output
      debug:
        msg: |
          Master node {{ inventory_hostname }} join result:
          Command: {{ master_token | replace('microk8s', '/snap/bin/microk8s') }}
          Return code: {{ master_join_result.rc }}
          Output:
          {{ master_join_result.stdout }}
          {% if master_join_result.stderr %}
          Error output:
          {{ master_join_result.stderr }}
          {% endif %}
      when:
        - inventory_hostname in groups['masters']
        - inventory_hostname != primary_master
      tags: cluster

    - name: Wait for additional masters to be ready
      shell: /snap/bin/microk8s status --wait-ready
      when:
        - inventory_hostname in groups['masters']
        - inventory_hostname != primary_master
      changed_when: false
      retries: 10
      delay: 10
      tags: cluster

    - name: Wait for all masters to stabilize on primary master
      shell: /snap/bin/microk8s status --wait-ready
      when: inventory_hostname == primary_master
      changed_when: false
      tags: cluster

    ###########################################################################
    # PHASE 6 — Join workers (each uses its own token)
    ###########################################################################

    - name: Store worker join token (per-node)
      set_fact:
        worker_token: "{{ hostvars[primary_master]['worker_join_map'][inventory_hostname] }}"
      when: inventory_hostname in groups['workers']
      tags: cluster

    - name: Display worker join command that will be executed
      debug:
        msg: "Joining worker node {{ inventory_hostname }} to cluster with command:\n{{ worker_token | replace('microk8s', '/snap/bin/microk8s') }}"
      when: inventory_hostname in groups['workers']
      tags: cluster

    - name: Join worker nodes to cluster
      shell: "{{ worker_token | replace('microk8s', '/snap/bin/microk8s') }}"
      when: inventory_hostname in groups['workers']
      register: worker_join_result
      changed_when: "'Successfully joined' in worker_join_result.stdout or worker_join_result.rc == 0"
      failed_when: false
      tags: cluster

    - name: Display worker join command output
      debug:
        msg: |
          Worker node {{ inventory_hostname }} join result:
          Command: {{ worker_token | replace('microk8s', '/snap/bin/microk8s') }}
          Return code: {{ worker_join_result.rc }}
          Output:
          {{ worker_join_result.stdout }}
          {% if worker_join_result.stderr %}
          Error output:
          {{ worker_join_result.stderr }}
          {% endif %}
      when: inventory_hostname in groups['workers']
      tags: cluster

    - name: Wait for worker nodes to be ready
      shell: /snap/bin/microk8s status --wait-ready
      when: inventory_hostname in groups['workers']
      changed_when: false
      tags: cluster

    # Phase 7: Configure kubectl access
    - name: Generate kubeconfig on primary master
      shell: /snap/bin/microk8s config > /home/{{ ansible_user }}/.kube/config
      when: inventory_hostname == primary_master
      tags: config

    - name: Set kubeconfig permissions
      file:
        path: "/home/{{ ansible_user }}/.kube/config"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      when: inventory_hostname == primary_master
      tags: config

    - name: Create kubectl alias
      lineinfile:
        path: "/home/{{ ansible_user }}/.bashrc"
        line: "alias kubectl='/snap/bin/microk8s kubectl'"
        create: yes
      tags: config

    # Phase 8: Verify cluster
    - name: Get cluster nodes
      shell: /snap/bin/microk8s kubectl get nodes -o wide
      when: inventory_hostname == primary_master
      register: cluster_nodes
      changed_when: false
      tags: verify

    - name: Display cluster status
      debug:
        msg: "Cluster nodes:\n{{ cluster_nodes.stdout }}"
      when: inventory_hostname == primary_master
      tags: verify

    - name: Verify expected number of nodes
      assert:
        that:
          - cluster_nodes.stdout_lines | length >= (groups['masters'] | length + groups['workers'] | length)
        fail_msg: "Expected {{ groups['masters'] | length + groups['workers'] | length }} nodes ({{ groups['masters'] | length }} masters + {{ groups['workers'] | length }} workers), but found {{ cluster_nodes.stdout_lines | length - 1 }}"
        success_msg: "Cluster has correct number of nodes"
      when: inventory_hostname == primary_master
      tags: verify
